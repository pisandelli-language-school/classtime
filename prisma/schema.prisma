generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ROOT
  MANAGER
  TEACHER
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  name       String?
  role       Role
  hourlyRate Decimal?
  active     Boolean  @default(true)

  assignments    Assignment[]
  timesheets     TimesheetPeriod[]
  auditLogs      AuditLog[]
  weeklyStatuses WeeklyTimesheetStatus[]
}

model Assignment {
  id        String @id @default(uuid())
  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id])

  studentId String?
  classId   String?
  student   Student? @relation(fields: [studentId], references: [id])
  class     Class?   @relation(fields: [classId], references: [id])

  timeEntries TimeEntry[]
}

model Student {
  id                  String       @id @default(uuid())
  name                String
  assignments         Assignment[]
  contracts           Contract[]
  classes             Class[]
  attendedTimeEntries TimeEntry[]
}

model Class {
  id          String    @id @default(uuid())
  name        String
  // Legacy fields (can be removed later or kept for backwards compat)
  totalHours  Decimal?  @default(0)
  weeklyHours Decimal?  @default(0)
  startDate   DateTime?
  endDate     DateTime?

  assignments Assignment[]
  contracts   Contract[]
  students    Student[]
}

enum ContractStatus {
  ACTIVE
  ARCHIVED
}

model Contract {
  id String @id @default(uuid())

  // Relations (Polymorphic-ish: one must be set)
  classId   String?
  class     Class?   @relation(fields: [classId], references: [id])
  studentId String?
  student   Student? @relation(fields: [studentId], references: [id])

  // Contract Details
  totalHours  Decimal // e.g., 40h package
  weeklyHours Decimal // e.g., 2h/week
  startDate   DateTime
  endDate     DateTime? // Predicted or Fixed

  status    ContractStatus @default(ACTIVE) // ACTIVE, ARCHIVED
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model TimesheetPeriod {
  id              String          @id @default(uuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  month           Int
  year            Int
  status          TimesheetStatus @default(DRAFT)
  rejectionReason String?

  entries TimeEntry[]

  @@unique([userId, month, year])
}

model TimeEntry {
  id                String          @id @default(uuid())
  timesheetPeriodId String
  timesheetPeriod   TimesheetPeriod @relation(fields: [timesheetPeriodId], references: [id])
  date              DateTime
  duration          Decimal
  description       String
  observations      String?
  type              String          @default("Normal")
  assignmentId      String
  assignment        Assignment      @relation(fields: [assignmentId], references: [id])

  // Removed unique constraint to allow multiple entries per day for same assignment
  attendees Student[]
}

enum AuditAction {
  SUBMIT
  APPROVE
  REJECT
  LOGIN
  CREATE_ENTRY
  UPDATE_ENTRY
  DELETE_ENTRY
}

model AuditLog {
  id        String      @id @default(uuid())
  actorId   String
  actor     User        @relation(fields: [actorId], references: [id])
  action    AuditAction
  targetId  String?
  timestamp DateTime    @default(now())
  metadata  Json?
}

enum WeeklyStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

model WeeklyTimesheetStatus {
  id              String       @id @default(uuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  year            Int
  week            Int
  status          WeeklyStatus @default(PENDING)
  rejectionReason String?

  submissionDate DateTime?
  approvalDate   DateTime?

  @@unique([userId, year, week])
}
